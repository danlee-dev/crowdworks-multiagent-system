import pandas as pd
import re
import numpy as np

def clean_column_name(name: str) -> str:
    """ì»¬ëŸ¼ëª…ì„ DBì— ì í•©í•˜ê²Œ ì •ì œí•©ë‹ˆë‹¤."""
    name = str(name)
    # ê°œí–‰ ë¬¸ì ë° ë¶ˆí•„ìš”í•œ ê³µë°± ì œê±°
    name = name.replace("\n", " ").replace("\r", " ").replace("\t", " ")
    name = re.sub(r"\s+", " ", name).strip()
    # ë‹¨ìœ„ í†µì¼
    name = name.replace("(mg)", "(mg/100g)").replace("(g)", "(g/100g)")
    name = name.replace("(kcal)", "(kcal/100g)")
    name = name.replace("(Î¼g)", "(Î¼g/100g)").replace("(ug)", "(Î¼g/100g)")
    # ì—‘ì…€ì˜ ë©€í‹°í—¤ë”ì—ì„œ ë°œìƒí•˜ëŠ” ë¶ˆí•„ìš”í•œ ë¶€ë¶„ ì œê±°
    name = re.sub(r"\s*\(Unnamed:.*?\)", "", name)
    # ë³´ì´ì§€ ì•ŠëŠ” ê³µë°± ë¬¸ì ì œê±°
    name = name.replace("\u200b", "").replace("Â ", " ")
    return name.strip()

def get_table_column_mapping(all_columns: list[str]) -> dict:
    """
    ì „ì²´ ì»¬ëŸ¼ ë¦¬ìŠ¤íŠ¸ë¥¼ ë°›ì•„ í…Œì´ë¸”ë³„ë¡œ ì •í™•íˆ ê·¸ë£¹í™”ëœ ì»¬ëŸ¼ ë§µì„ ë°˜í™˜í•©ë‹ˆë‹¤.
    """
    # ê° í…Œì´ë¸”ì— ì†í•˜ëŠ” ì»¬ëŸ¼ë“¤ì„ ëª…ì‹œì ìœ¼ë¡œ ì •ì˜
    table_definitions = {
        "foods": [
            "DB10.2 ìƒ‰ì¸", "10ê°œì • ì±…ì ìƒ‰ì¸", "ì‹í’ˆêµ°", "ì‹í’ˆëª…", "ì¶œì²˜", "íê¸°ìœ¨_percent" # '%' ê¸°í˜¸ ì œê±°
        ],
        "proximates": [
            "ì—ë„ˆì§€ (kcal/100g)", "ìˆ˜ë¶„ (g/100g)", "ë‹¨ë°±ì§ˆ (g/100g)", "ì§€ë°© (g/100g)", "íšŒë¶„ (g/100g)",
            "íƒ„ìˆ˜í™”ë¬¼ (g/100g)", "ë‹¹ë¥˜ (g/100g)", "ìë‹¹ (g/100g)", "í¬ë„ë‹¹ (g/100g)", "ê³¼ë‹¹ (g/100g)",
            "ìœ ë‹¹ (g/100g)", "ë§¥ì•„ë‹¹ (g/100g)", "ê°ˆë½í† ì˜¤ìŠ¤ (g/100g)", "ì´ ì‹ì´ì„¬ìœ  (g/100g)",
            "ìˆ˜ìš©ì„± ì‹ì´ì„¬ìœ  (g/100g)", "ë¶ˆìš©ì„± ì‹ì´ì„¬ìœ  (g/100g)", "ì‹ì—¼ìƒë‹¹ëŸ‰ (g/100g)"
        ],
        "minerals": [
            "ì¹¼ìŠ˜ (mg/100g)", "ì²  (mg/100g)", "ë§ˆê·¸ë„¤ìŠ˜ (mg/100g)", "ì¸ (mg/100g)", "ì¹¼ë¥¨ (mg/100g)",
            "ë‚˜íŠ¸ë¥¨ (mg/100g)", "ì•„ì—° (mg/100g)", "êµ¬ë¦¬ (mg/100g)", "ë§ê°„ (mg/100g)", "ì…€ë ˆëŠ„ (Î¼g/100g)",
            "ëª°ë¦¬ë¸Œë´ (Î¼g/100g)", "ìš”ì˜¤ë“œ (Î¼g/100g)"
        ],
        "vitamins": [
            "ë¹„íƒ€ë¯¼ A (Î¼g/100g)", "ë ˆí‹°ë†€ (Î¼g/100g)", "ë² íƒ€ì¹´ë¡œí‹´ (Î¼g/100g)", "í‹°ì•„ë¯¼ (mg/100g)",
            "ë¦¬ë³´í”Œë¼ë¹ˆ (mg/100g)", "ë‹ˆì•„ì‹  (mg/100g)", "ë‹ˆì•„ì‹ ë‹¹ëŸ‰(NE) (mg/100g)", "ë‹ˆì½”í‹´ì‚° (mg/100g)",
            "ë‹ˆì½”í‹´ì•„ë¯¸ë“œ (mg/100g)", "íŒí† í…ì‚° (mg/100g)", "ë¹„íƒ€ë¯¼ B6 (mg/100g)", "í”¼ë¦¬ë…ì‹  (mg/100g)",
            "ë¹„ì˜¤í‹´ (Î¼g/100g)", "ì—½ì‚°_ ì—½ì‚°ë‹¹ëŸ‰ (Î¼g/100g)", "ì—½ì‚°_ ì‹í’ˆ ì—½ì‚° (Î¼g/100g)",
            "ì—½ì‚°_ í•©ì„± ì—½ì‚° (Î¼g/100g)", "ë¹„íƒ€ë¯¼ B12 (Î¼g/100g)", "ë¹„íƒ€ë¯¼ C (mg/100g)", "ë¹„íƒ€ë¯¼ D (Î¼g/100g)",
            "ë¹„íƒ€ë¯¼ D2 (Î¼g/100g)", "ë¹„íƒ€ë¯¼ D3 (Î¼g/100g)", "ë¹„íƒ€ë¯¼ E (mg/100g)", "ì•ŒíŒŒ í† ì½”í˜ë¡¤ (mg/100g)",
            "ë² íƒ€ í† ì½”í˜ë¡¤ (mg/100g)", "ê°ë§ˆ í† ì½”í˜ë¡¤ (mg/100g)", "ë¸íƒ€ í† ì½”í˜ë¡¤ (mg/100g)",
            "ì•ŒíŒŒ í† ì½”íŠ¸ë¦¬ì—ë†€ (mg/100g)", "ë² íƒ€ í† ì½”íŠ¸ë¦¬ì—ë†€ (mg/100g)", "ê°ë§ˆ í† ì½”íŠ¸ë¦¬ì—ë†€ (mg/100g)",
            "ë¸íƒ€ í† ì½”íŠ¸ë¦¬ì—ë†€ (mg/100g)", "ë¹„íƒ€ë¯¼ K (Î¼g/100g)", "ë¹„íƒ€ë¯¼ K1 (Î¼g/100g)", "ë¹„íƒ€ë¯¼ K2 (Î¼g/100g)"
        ],
        "amino_acids": [
            "ì´ ì•„ë¯¸ë…¸ì‚° (mg/100g)", "ì´ í•„ìˆ˜ ì•„ë¯¸ë…¸ì‚° (mg/100g)", "ì´ì†Œë¥˜ì‹  (mg/100g)", "ë¥˜ì‹  (mg/100g)",
            "ë¼ì´ì‹  (mg/100g)", "ë©”í‹°ì˜¤ë‹Œ (mg/100g)", "í˜ë‹ì•Œë¼ë‹Œ (mg/100g)", "íŠ¸ë ˆì˜¤ë‹Œ (mg/100g)",
            "íŠ¸ë¦½í† íŒ (mg/100g)", "ë°œë¦° (mg/100g)", "íˆìŠ¤í‹°ë”˜ (mg/100g)", "ì•„ë¥´ê¸°ë‹Œ (mg/100g)",
            "í‹°ë¡œì‹  (mg/100g)", "ì‹œìŠ¤í…Œì¸ (mg/100g)", "ì•Œë¼ë‹Œ (mg/100g)", "ì•„ìŠ¤íŒŒë¥´íŠ¸ì‚° (mg/100g)",
            "ê¸€ë£¨íƒì‚° (mg/100g)", "ê¸€ë¼ì´ì‹  (mg/100g)", "í”„ë¡¤ë¦° (mg/100g)", "ì„¸ë¦° (mg/100g)", "íƒ€ìš°ë¦° (mg/100g)"
        ],
        "fatty_acids": [
            "ì½œë ˆìŠ¤í…Œë¡¤ (mg/100g)", "ì´ ì§€ë°©ì‚° (g/100g)", "ì´ í•„ìˆ˜ ì§€ë°©ì‚° (g/100g)", "ì´ í¬í™” ì§€ë°©ì‚° (g/100g)",
            "ë¶€í‹°ë¥´ì‚° (4:0) (mg/100g)", "ì¹´í”„ë¡œì‚° (6:0) (mg/100g)", "ì¹´í”„ë¦´ì‚° (8:0) (mg/100g)",
            "ì¹´í”„ë¥´ì‚° (10:0) (mg/100g)", "ë¼ìš°ë¥´ì‚° (12:0) (mg/100g)", "íŠ¸ë¼ì´ë°ì¹¸ì‚° (13:0) (mg/100g)",
            "ë¯¸ë¦¬ìŠ¤íŠ¸ì‚° (14:0) (mg/100g)", "íœíƒ€ë°ì¹¸ì‚° (15:0) (mg/100g)", "íŒ”ë¯¸íŠ¸ì‚° (16:0) (mg/100g)",
            "í—µíƒ€ë°ì¹¸ì‚° (17:0) (mg/100g)", "ìŠ¤í…Œì•„ë¥´ì‚° (18:0) (mg/100g)", "ì•„ë¼í‚¤ë“œì‚° (20:0) (mg/100g)",
            "í—¨ì—ì´ì½”ì‚°ì‚° (21:0) (mg/100g)", "ë² í—¨ì‚° (22:0) (mg/100g)", "íŠ¸ë¦¬ì½”ì‚°ì‚° (23:0) (mg/100g)",
            "ë¦¬ê·¸ë…¸ì„¸ë¥´ì‚° (24:0) (mg/100g)", "ì´ ë¶ˆí¬í™” ì§€ë°©ì‚° (g/100g)", "ì´ ë‹¨ì¼ ë¶ˆí¬í™”ì§€ë°©ì‚° (g/100g)",
            "ë¯¸ë¦¬ìŠ¤í†¨ë ˆì‚° (14:1) (mg/100g)", "íŒ”ë¯¸í†¨ë ˆì‚° (16:1) (mg/100g)", "í—µíƒ€ë°ì„¼ì‚° (17:1) (mg/100g)",
            "ì˜¬ë ˆì‚° (18:1(n-9)) (mg/100g)", "ë°•ì„¼ì‚° (18:1(n-7)) (mg/100g)", "ê°€ëŒë ˆì‚° (20:1) (mg/100g)",
            "ì—ë£¨í¬ì‚° (22:1) (mg/100g)", "ë„¤ë¥´ë³¸ì‚° (24:1) (mg/100g)", "ì´ ë‹¤ê°€ ë¶ˆí¬í™”ì§€ë°©ì‚° (g/100g)",
            "ë¦¬ë†€ë ˆì‚° (18:2(n-6)) (mg/100g)", "ì•ŒíŒŒ ë¦¬ë†€ë Œì‚° (18:3 (n-3)) (mg/100g)",
            "ê°ë§ˆ ë¦¬ë†€ë Œì‚° (18:3 (n-6)) (mg/100g)", "ì—ì´ì½”ì‚¬ ë””ì—ë…¸ì‚° (20:2(n-6)) (mg/100g)",
            "ë””í˜¸ëª¨ ë¦¬ë†€ë Œì‚° (20:3(n-3)) (mg/100g)", "ì—ì´ì½”ì‚¬ íŠ¸ë¦¬ì—ë…¸ì‚° (20:3(n-6)) (mg/100g)",
            "ì•„ë¼í‚¤ëˆì‚° (20:4(n-6)) (mg/100g)", "ì—ì´ì½”ì‚¬ íœíƒ€ì—ë…¸ì‚° (20:5(n-3)) (mg/100g)",
            "ë„ì½”ì‚¬ ë””ì—ë…¸ì‚°(22:2) (mg/100g)", "ë„ì½”ì‚¬ íœíƒ€ì—ë…¸ì‚° (22:5(n-3)) (mg/100g)",
            "ë„ì½”ì‚¬ í—¥ì‚¬ì—ë…¸ì‚° (22:6(n-3)) (mg/100g)", "ì˜¤ë©”ê°€3 ì§€ë°©ì‚° (g/100g)", "ì˜¤ë©”ê°€6 ì§€ë°©ì‚° (g/100g)",
            "ì´ íŠ¸ëœìŠ¤ ì§€ë°©ì‚° (g/100g)", "íŠ¸ëœìŠ¤ ì˜¬ë ˆì‚°(18:1(n-9)t) (mg/100g)",
            "íŠ¸ëœìŠ¤ ë¦¬ë†€ë ˆì‚°(18:2t) (mg/100g)", "íŠ¸ëœìŠ¤ ë¦¬ë†€ë Œì‚°(18:3t) (mg/100g)"
        ]
    }

    # ë¹ ë¥¸ ì¡°íšŒë¥¼ ìœ„í•´ ì»¬ëŸ¼ëª… -> í…Œì´ë¸”ëª… ì—­ë°©í–¥ ë§µ ìƒì„±
    column_to_table_map = {}
    for table_name, columns in table_definitions.items():
        for column in columns:
            column_to_table_map[column] = table_name

    # ìµœì¢…ì ìœ¼ë¡œ ë°˜í™˜í•  ë§µ êµ¬ì¡° ì´ˆê¸°í™”
    final_mapping = {
        "foods": [], "proximates": [], "minerals": [],
        "vitamins": [], "amino_acids": [], "fatty_acids": [],
    }

    # ì—‘ì…€ì—ì„œ ì½ì–´ì˜¨ ëª¨ë“  ì»¬ëŸ¼ì„ ìˆœíšŒí•˜ë©° ë§¤í•‘
    for col in all_columns:
        table = column_to_table_map.get(col)
        if table:
            final_mapping[table].append(col)
        else:
            # ì–´ë–¤ í…Œì´ë¸”ì—ë„ ì†í•˜ì§€ ì•ŠëŠ” ì»¬ëŸ¼ì´ ìˆë‹¤ë©´ ê²½ê³  ë©”ì‹œì§€ ì¶œë ¥
            print(f"âš ï¸ ê²½ê³ : '{col}' ì»¬ëŸ¼ì´ ì–´ë–¤ í…Œì´ë¸”ì—ë„ í• ë‹¹ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.")

    return final_mapping

def load_nutrition_facts(file_path: str, sheet_name="êµ­ê°€í‘œì¤€ì‹í’ˆì„±ë¶„ Database 10.2"):
    """
    ì—‘ì…€ ë°ì´í„°ë¥¼ ë¡œë“œí•˜ê³ , ëª¨ë“  ìˆ«ì ì»¬ëŸ¼ì„ ì•ˆì •ì ìœ¼ë¡œ ì •ì œí•˜ì—¬ DataFrameìœ¼ë¡œ ë°˜í™˜í•©ë‹ˆë‹¤.
    """
    print(f"ğŸ“¥ ì—‘ì…€ ë¡œë”© ì¤‘: {file_path}")
    df = pd.read_excel(file_path, sheet_name=sheet_name, header=[1, 2])
    # ë©€í‹° ë ˆë²¨ í—¤ë”ë¥¼ ë³‘í•©í•˜ê³  ë¹ˆ ê°’ì„ ì±„ì›€
    df.columns = df.columns.to_frame().ffill().apply(tuple, axis=1)
    print(f"ğŸ“Š ì›ë³¸ shape: {df.shape}, columns: {len(df.columns)}")

    # ì»¬ëŸ¼ëª… ì •ì œ ë° ìƒì„±
    column_names = []
    seen = set()
    for i, (c1, c2) in enumerate(df.columns):
        base = f"{str(c1)} ({str(c2)})" if not pd.isna(c2) and "Unnamed" not in str(c2) else str(c1)
        clean = clean_column_name(base)
        
        # íŠ¹ìˆ˜í•œ ê²½ìš° ì»¬ëŸ¼ëª… ê°•ì œ í• ë‹¹
        if i == 87:
            clean = "ì½œë ˆìŠ¤í…Œë¡¤ (mg/100g)"
        elif i == 135:
            clean = "ì‹ì—¼ìƒë‹¹ëŸ‰ (g/100g)"
        elif i == 136:
            # --- [FIX] ---
            # '%' ê¸°í˜¸ê°€ í¬í•¨ëœ ì»¬ëŸ¼ëª…ì„ DB ì¹œí™”ì ìœ¼ë¡œ ë³€ê²½
            clean = "íê¸°ìœ¨_percent"
            # --- [END OF FIX] ---
        
        # ì¤‘ë³µ ì»¬ëŸ¼ëª… ì²˜ë¦¬
        original = clean
        suffix = 1
        while clean in seen:
            clean = f"{original}_{suffix}"
            suffix += 1
        seen.add(clean)
        column_names.append(clean)

    # ìµœì¢… ì»¬ëŸ¼ëª… ë¦¬ìŠ¤íŠ¸ì—ì„œ ë‹¤ì‹œ í•œë²ˆ ê³µë°± ì œê±°
    column_names = [re.sub(r"[\n\r\t\xa0\u200b]", " ", c).strip() for c in column_names]
    df.columns = column_names
    
    # DBì— NULLë¡œ ë„£ì–´ì•¼ í•  ê°’ë“¤ì„ np.nanìœ¼ë¡œ ë³€í™˜
    df = df.replace(["-", "", "Tr", "( )"], np.nan) 

    # ìˆ«ìí˜•ì´ì–´ì•¼ í•˜ëŠ” ì»¬ëŸ¼ë“¤ì„ ëª…ì‹œì ìœ¼ë¡œ ì°¾ì•„ ìˆ«ì íƒ€ì…ìœ¼ë¡œ ë³€ê²½ (ì˜¤ë¥˜ ì‹œ NaN ì²˜ë¦¬)
    numeric_cols = [
        col for col in df.columns 
        if any(key in col for key in ["ìƒ‰ì¸", "ì½”ë“œ", "(g/100g)", "(mg/100g)", "(Î¼g/100g)", "(kcal/100g)", "(%)", "_percent"])
    ]
    for col in numeric_cols:
        df[col] = pd.to_numeric(df[col], errors='coerce')

    # DataFrame ì „ì²´ì˜ np.nan ê°’ì„ íŒŒì´ì¬ì˜ Noneìœ¼ë¡œ ìµœì¢… ë³€í™˜
    df = df.where(pd.notnull(df), None)
    df = df.reset_index(drop=True)

    print(f"\nâœ… ì •ì œëœ shape: {df.shape}, ìµœì¢… ì»¬ëŸ¼ ìˆ˜: {len(df.columns)}")
    
    return df
